[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = true

###############################################################################
#                            OUTPUT PLUGINS                                  #
###############################################################################

[[outputs.influxdb]]
  urls = ["http://influxdb:8086"]
  database = "shelly"
  timeout = "5s"
  retention_policy = ""
  username = ""
  password = ""

###############################################################################
#                            INPUT PLUGINS                                   #
###############################################################################

# Numeric readings such as power, temperature, humidity or energy counters.
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [
    "shellies/+/relay/+/power",
    "shellies/+/relay/+/energy",
    "shellies/+/sensor/temperature",
    "shellies/+/sensor/humidity",
    "shellies/+/sensor/battery",
    "shellies/+/temperature",
    "shellies/+/humidity"
  ]
  qos = 0
  connection_timeout = "30s"
  persistent_session = false
  client_id = "telegraf-shelly-metrics"
  username = "$MQTT_USERNAME"
  password = "$MQTT_PASSWORD"
  data_format = "value"
  data_type = "float"
  name_override = "shelly_measurements"
  topic_tag = "topic"

# Binary states such as open/close sensors and switches.
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [
    "shellies/+/input_event/+/event",
    "shellies/+/sensor/door",
    "shellies/+/sensor/window",
    "shellies/+/status"
  ]
  qos = 0
  connection_timeout = "30s"
  persistent_session = false
  client_id = "telegraf-shelly-states"
  username = "$MQTT_USERNAME"
  password = "$MQTT_PASSWORD"
  data_format = "value"
  data_type = "string"
  name_override = "shelly_states"
  topic_tag = "topic"

###############################################################################
#                             PROCESSOR PLUGINS                              #
###############################################################################

# Parse the device identifier from the MQTT topic and expose it as a tag so
# dashboards can be filtered by device name.
[[processors.regex]]
  namepass = ["shelly_measurements", "shelly_states"]
  [[processors.regex.tags]]
    key = "topic"
    pattern = "shellies/([^/]+)/.*"
    replacement = "${1}"
    result_key = "device"

# Optional: normalize the field key for string payloads to "state" so Grafana
# can display it in tables.
[[processors.rename]]
  namepass = ["shelly_states"]
  [[processors.rename.replace]]
    field = "value"
    dest = "state"

# Optional: for numeric metrics rename the field to "value" -> "reading" to
# make Grafana queries more expressive.
[[processors.rename]]
  namepass = ["shelly_measurements"]
  [[processors.rename.replace]]
    field = "value"
    dest = "reading"

